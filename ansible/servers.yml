---
# Load datas
- import_playbook: data.yml
  vars:
    data_path: "../ad/{{domain_name}}/data/"
  tags: 'data'

- name: "Install IIS"
  hosts: iis
  roles:
    - { role: 'iis', tags: 'iis'}

- name: "Install MSSQL Express"
  hosts: mssql
  roles:
    - { role: 'mssql', tags: 'mssql'}
    - { role: 'mssql_link', tags: 'mssql, mssql_link'}
  vars:
    domain: "{{lab.hosts[inventory_hostname].domain}}"
    SQLSVCACCOUNT_NAME: "{{lab.hosts[inventory_hostname].mssql.svcaccount| default('NT AUTHORITY\\NETWORK SERVICE')}}"
    SQLSVCACCOUNT_NAMEDOMAIN: "{{domain}}\\{{SQLSVCACCOUNT_NAME}}"
    SQLSVCACCOUNT: "{{SQLSVCACCOUNT_NAME if SQLSVCACCOUNT_NAME == 'NT AUTHORITY\\NETWORK SERVICE' else SQLSVCACCOUNT_NAMEDOMAIN }}"
    SQLSVCPASSWORD: "{{lab.domains[domain].users[SQLSVCACCOUNT_NAME].password| default('')}}"
    SQLYSADMIN: "{{SQLSVCACCOUNT}}"
    domain_admin: "{{domain}}\\Administrator"
    domain_admin_password: "{{lab.domains[domain].domain_password}}"
    sql_sysadmins: "{{lab.hosts[inventory_hostname].mssql.sysadmins | default([]) }}"
    executeaslogin: "{{lab.hosts[inventory_hostname].mssql.executeaslogin  | default({}) }}"
    executeasuser:  "{{lab.hosts[inventory_hostname].mssql.executeasuser | default({}) }}"
    sa_password: "{{lab.hosts[inventory_hostname].mssql.sa_password}}"
    linked_servers: "{{lab.hosts[inventory_hostname].mssql.linked_servers | default({}) }}"

- name: "Install SQL Server Management Studio"
  hosts: mssql_ssms
  roles:
    - { role: 'mssql_ssms', tags: 'mssql_ssms'}

- name: "Install SQL Server reporting"
  hosts: mssql_reporting
  roles:
    - { role: 'mssql_reporting', tags: 'mssql_reporting'}
  vars:
    domain: "{{lab.hosts[inventory_hostname].domain}}"
    domain_admin: "{{domain}}\\Administrator"
    domain_admin_password: "{{lab.domains[domain].domain_password}}"

- name: "Install Webdav"
  hosts: webdav
  roles:
    - { role: 'webdav', tags: 'webdav'}